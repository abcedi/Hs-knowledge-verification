<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Health & Safety Knowledge Quiz</title>

  <style>
    body {
      margin: 0;
      padding: 18px;
      font-family: system-ui, -apple-system, Arial;
      background: #0f0f0f;
      color: #fff;
    }
    h1 { margin: 0 0 14px 0; }
    #quiz { padding-bottom: 140px; }

    .qblock {
      margin: 18px 0;
      padding-bottom: 14px;
      border-bottom: 1px solid #333;
    }
    .topic {
      opacity: 0.7;
      font-style: italic;
      font-size: 0.9em;
      margin-top: 4px;
    }

    label {
      display: block;
      margin-top: 10px;
      cursor: pointer;
      line-height: 1.25;
    }
    input[type="radio"] { transform: scale(1.1); margin-right: 10px; }

    .textInput {
      width: 100%;
      box-sizing: border-box;
      margin-top: 10px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #444;
      background: #111;
      color: #fff;
      font-size: 16px;
      outline: none;
    }

    #submit {
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 16px;
      padding: 18px;
      font-size: 18px;
      border-radius: 14px;
      border: none;
      background: #1e90ff;
      color: #fff;
      z-index: 9999;
      cursor: pointer;
      touch-action: manipulation;
    }
    #submit:disabled { opacity: 0.7; }

    #status {
      margin-top: 12px;
      white-space: pre-wrap;
      font-size: 0.95em;
      opacity: 0.95;
    }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      border: 1px solid #444;
      border-radius: 999px;
      font-size: 12px;
      opacity: 0.9;
      margin-top: 6px;
    }
  </style>
</head>

<body>
  <h1>Health & Safety Knowledge Check</h1>
  <div class="pill" id="meta">Loading…</div>

  <div id="quiz"></div>

  <button id="submit" type="button">Submit</button>
  <div id="status">Loading…</div>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const quizDiv = document.getElementById("quiz");
    const submitBtn = document.getElementById("submit");
    const statusEl = document.getElementById("status");
    const metaEl = document.getElementById("meta");

    let questions = [];

    const setStatus = (t) => { statusEl.textContent = t; };
    const setMeta = (t) => { metaEl.textContent = t; };

    function getBadgeFromUser(user) {
      const email = user?.email || "";
      const badge = email.includes("@") ? email.split("@")[0] : "";
      return badge;
    }

    async function loadQuiz() {
      const res = await fetch("./data/questions.json", { cache: "no-store" });
      const data = await res.json();

      if (!Array.isArray(data)) {
        throw new Error("questions.json must be an array of questions.");
      }

      questions = data;

      quizDiv.innerHTML = "";

      questions.forEach((q, i) => {
        const block = document.createElement("div");
        block.className = "qblock";

        const qType = q.type || (Array.isArray(q.choices) ? "mc" : "mc");
        const topic = q.topic || "Uncategorized";
        const prompt = q.question || "(missing question text)";

        let inner = `
          <div>
            <strong>${i + 1}. ${prompt}</strong>
            <div class="topic">(${topic})</div>
          </div>
        `;

        if (qType === "text") {
          inner += `
            <input
              class="textInput"
              type="text"
              id="t${i}"
              placeholder="Type your answer…"
              ${q.required ? "required" : ""}
            />
          `;
        } else {
          const choices = Array.isArray(q.choices) ? q.choices : [];
          inner += choices.map((c, idx) => `
            <label>
              <input type="radio" name="q${i}" value="${idx}">
              ${c}
            </label>
          `).join("");
        }

        block.innerHTML = inner;
        quizDiv.appendChild(block);
      });

      const scoredCount = questions.filter(q => (q.scored !== false) && (q.type !== "text")).length;
      setMeta(`Questions: ${questions.length} | Scored: ${scoredCount}`);
    }

    function collectAllAnswers() {
      const answers = [];
      const profile = {};
      let score = 0;
      let scoredTotal = 0;
      const wrong = [];

      for (let i = 0; i < questions.length; i++) {
        const q = questions[i];
        const qType = q.type || (Array.isArray(q.choices) ? "mc" : "mc");

        if (qType === "text") {
          const el = document.getElementById(`t${i}`);
          const val = (el?.value || "").trim();

          if (q.required && !val) {
            return { error: `Please complete: "${q.question}"` };
          }

          answers.push({
            id: q.id || `t_${i+1}`,
            type: "text",
            value: val
          });

          // store known fields neatly
          if (q.id === "meta_name") profile.name = val;
          if (q.id === "meta_restaurant") profile.restaurant = val;

          continue;
        }

        const selected = document.querySelector(`input[name="q${i}"]:checked`);
        const chosen = selected ? Number(selected.value) : null;

        if (chosen === null) {
          return { error: `Please answer question ${i + 1}.` };
        }

        answers.push({
          id: q.id || `q_${i+1}`,
          type: "mc",
          chosenIndex: chosen
        });

        const isScored = (q.scored !== false);
        if (isScored) {
          scoredTotal++;
          const correct = Number(q.answerIndex);

          if (chosen === correct) {
            score++;
          } else {
            wrong.push({
              questionId: q.id || `q_${i + 1}`,
              topic: q.topic || "Uncategorized",
              chosenIndex: chosen,
              correctIndex: correct
            });
          }
        }
      }

      return { profile, answers, score, total: scoredTotal, wrong };
    }

    function withTimeout(promise, ms) {
      return Promise.race([
        promise,
        new Promise((_, reject) =>
          setTimeout(() => reject(new Error(`Save timed out (${Math.round(ms/1000)}s). Try again.`)), ms)
        )
      ]);
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      try {
        setStatus("Loading questions…");
        await loadQuiz();
        setStatus("Answer the questions, then press Submit.");
      } catch (err) {
        setStatus(`Failed to load questions ❌\n${err?.message || err}`);
      }
    });

    async function handleSubmit(e) {
      e.preventDefault();

      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting…";
      setStatus("Submitting…");

      try {
        if (!navigator.onLine) {
          throw new Error("You appear to be offline. Connect to Wi-Fi/data and try again.");
        }

        if (!auth.currentUser) {
          window.location.href = "index.html";
          return;
        }

        const collected = collectAllAnswers();
        if (collected.error) {
          throw new Error(collected.error);
        }

        const badge = getBadgeFromUser(auth.currentUser);

        await withTimeout(
          addDoc(collection(db, "attempts"), {
            uid: auth.currentUser.uid,
            badge,
            profile: collected.profile,
            answers: collected.answers,
            score: collected.score,
            total: collected.total,
            wrong: collected.wrong,
            createdAt: serverTimestamp()
          }),
          12000
        );

        window.location.href =
          `results.html?status=ok&score=${encodeURIComponent(collected.score)}&total=${encodeURIComponent(collected.total)}&wrong=${encodeURIComponent(collected.wrong.length)}`;

      } catch (err) {
        const msg = err?.message || String(err);
        setStatus(`Not saved ❌\n${msg}\n\nFix the issue and press Submit again.`);
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit";
      }
    }

    submitBtn.addEventListener("click", handleSubmit, { passive: false });
    submitBtn.addEventListener("touchend", handleSubmit, { passive: false });
  </script>
</body>
</html>
